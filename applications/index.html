<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Application Papers Explorer</title>

    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/2.0.8/css/dataTables.dataTables.min.css">
    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/fixedheader/4.0.1/css/fixedHeader.dataTables.min.css">

    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        h1 { color: #333; }
        p { margin-bottom: 20px; }

        #paperTable {
            width: 100% !important;
            border-collapse: collapse;
            margin-top: 15px;
        }
        /* Global styling for all table cells: prevents text wrapping by default */
        #paperTable th, #paperTable td {
            border: 1px solid #ddd;
            padding: 4px 8px;
            text-align: left;
            font-size: 0.9em;
            white-space: nowrap; /* Forces content to stay on one line */
            box-sizing: border-box; /* Ensures padding/border are included in total width for better alignment */
        }
        #paperTable th {
            background-color: #f2f2f2;
            font-weight: bold;
        }

        /* --- CSS FOR VISUAL TRUNCATION (ONLY for 'title' column, or explicitly long ones) --- */
        #paperTable td.truncate {
            overflow: hidden;            /* Hides content that overflows the cell's boundaries */
            text-overflow: ellipsis;     /* Displays "..." for hidden content (at the end) */
            max-width: 450px;            /* ADJUST THIS VALUE to control 'title' column width.
                                            Make it smaller if the table is still too wide. */
        }
        /* End NEW CSS */

        /* Optional: Styling for the horizontal scrollbar introduced by DataTables scrollX */
        .dataTables_scrollBody {
            border-bottom: 1px solid #ddd;
        }
        /* Make the global search input and pagination controls a bit more spaced */
        .dataTables_wrapper .dataTables_filter,
        .dataTables_wrapper .dataTables_paginate {
            margin-bottom: 10px;
        }
        /* Style for the new info section */
        #info-section {
            background-color: #e9ecef;
            padding: 10px 15px;
            border-radius: 5px;
            margin-bottom: 20px;
            font-size: 0.9em;
            color: #495057;
        }
        #info-section p {
            margin-bottom: 5px; /* Reduce spacing between paragraphs in info section */
        }
        #info-section p:last-child {
            margin-bottom: 0;
        }
    </style>
</head>
<body>
    <h1>ðŸ”¬ Application Papers Exploratory Framework</h1>
    <p>Explore and filter the harmonized weak annotation pool for 'application' type papers directly in your browser.</p>

    <div id="info-section">
        <p>Number of application papers: <strong id="paperCount">Loading...</strong></p>
        <p>Last PubMed Scraping: <span id="lastPubMedScraping">Loading...</span></p>
        <p>Last LLM Curation: <span id="lastLlmCuration">Loading...</span></p>
        <p>Last Application Curation: <span id="lastApplicationCuration">Loading...</span></p>
        <p>This dataset was generated by scraping of Pubmed for spatial omics terms.</p>
        <p>Abstracts and titles were weakly annotated via LLM queries.</p>
        <p>Further improvements will include scraping of Gscholar, bioArxiv and the manual curation for more in-depth analysis.</p>
    </div>
    <table id="paperTable" class="display compact" style="width:100%">
        <thead>
            <tr>
                </tr>
        </thead>
        <tbody>
            </tbody>
    </table>

    <script type="text/javascript" src="https://code.jquery.com/jquery-3.7.1.min.js"></script>

    <script type="text/javascript" src="https://cdn.datatables.net/2.0.8/js/dataTables.min.js"></script>
    <script type="text/javascript" src="https://cdn.datatables.net/fixedheader/4.0.1/js/dataTables.fixedHeader.min.js"></script>

    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>

    <script type="text/javascript">
        // Function to dynamically get the base path for assets on GitHub Pages
        function getGithubPagesBasePath() {
            const pathname = window.location.pathname;
            const parts = pathname.split('/');
            if (parts.length > 1 && parts[1] !== '') {
                return '/' + parts[1];
            }
            return '';
        }

        $(document).ready(function() {
            const basePath = getGithubPagesBasePath();

            // --- CRITICAL: Verify these paths match the EXACT locations of your files on GitHub.com ---
            const csvFilePath = `${basePath}/data/weak_annotation_pool_application_papers_harmonized.csv`;
            const datesFilePath = `${basePath}/data/dates.json`; // Path to your dates.json file

            console.log("Attempting to load CSV from:", csvFilePath);

            function loadCsvAndInitializeTable() {
                Papa.parse(csvFilePath, {
                    download: true,
                    header: true,
                    skipEmptyLines: true,
                    complete: function(results) {
                        // Check for any parsing errors reported by PapaParse
                        if (results.errors.length > 0) {
                            console.error("PapaParse errors:", results.errors);
                            alert("Error parsing CSV data. Please check the CSV file for issues (e.g., malformed lines).");
                            return;
                        }

                        let originalHeaders = results.meta.fields; // All headers detected in your CSV
                        const data = results.data.map(row => originalHeaders.map(header => row[header]));

                        // --- YOUR DESIRED COLUMN ORDER ---
                        const desiredDisplayOrder = [
                            'title',
                            'curated_data_modalities_used',
                            'modalities_general',
                            'tissue',
                            'disease',
                            'animal',
                            'biological_context',
                            'main_goals',
                            'covered_analysis_steps',
                            'data_links_mentioned',
                            'doi',
                            'pmid',
                            'paper_type',
                            'annotation_status',
                            'llm_query_date',
                            'llm_model',
                            'relevance_score_llm'
                        ];

                        // Define columns for DataTables based on the desired order
                        const dataTableColumns = desiredDisplayOrder.map(colName => {
                            const colDef = {
                                title: colName,
                                data: originalHeaders.indexOf(colName),
                                // --- NEW: Universal render for tooltips on all columns ---
                                render: function (data, type, row) {
                                    if (type === 'display' && data !== null && data !== undefined) {
                                        // Handle arrays (e.g., for modalities) by joining them for display
                                        let displayData = Array.isArray(data) ? data.join(', ') : String(data);
                                        // Return a span with the full content as a title (tooltip)
                                        return '<span title="' + displayData.replace(/"/g, '&quot;') + '">' + displayData + '</span>';
                                    }
                                    return data; // For other types (filter, sort, etc.) or null/undefined, just return data
                                }
                                // --- END NEW ---
                            };

                            // Apply specific visual truncation class ONLY to 'title' (or other explicitly long columns)
                            if (colName === 'title') {
                                colDef.className = 'truncate';
                            }

                            return colDef;
                        });

                        const myTable = $('#paperTable').DataTable({
                            data: data,
                            columns: dataTableColumns,

                            paging: true,
                            searching: true,
                            ordering: true,
                            info: true,

                            scrollX: true,
                            autoWidth: false,

                            // --- NEW: Enable FixedHeader for robust alignment with horizontal scroll ---
                            fixedHeader: true,

                            // Explicit Column Widths for better alignment and control
                            columnDefs: [
                                // Adjust these width values as needed for your content and screen size
                                { width: '450px', targets: originalHeaders.indexOf('title') },
                                { width: '120px', targets: originalHeaders.indexOf('curated_data_modalities_used') },
                                { width: '100px', targets: originalHeaders.indexOf('modalities_general') },
                                { width: '80px', targets: originalHeaders.indexOf('tissue') },
                                { width: '80px', targets: originalHeaders.indexOf('disease') },
                                { width: '60px', targets: originalHeaders.indexOf('animal') },
                                { width: '150px', targets: originalHeaders.indexOf('biological_context') },
                                { width: '150px', targets: originalHeaders.indexOf('main_goals') },
                                { width: '150px', targets: originalHeaders.indexOf('covered_analysis_steps') },
                                { width: '100px', targets: originalHeaders.indexOf('data_links_mentioned') },
                                { width: '100px', targets: originalHeaders.indexOf('doi') },
                                { width: '80px', targets: originalHeaders.indexOf('pmid') },
                                { width: '80px', targets: originalHeaders.indexOf('paper_type') },
                                { width: '80px', targets: originalHeaders.indexOf('annotation_status') },
                                { width: '100px', targets: originalHeaders.indexOf('llm_query_date') },
                                { width: '80px', targets: originalHeaders.indexOf('llm_model') },
                                { width: '80px', targets: originalHeaders.indexOf('relevance_score_llm') }
                            ],
                            // Callback to adjust columns after initialization (still useful with FixedHeader)
                            initComplete: function() {
                                this.api().columns.adjust().draw();
                            }
                        });

                        // --- Update dynamic info after table initialization ---
                        $('#paperCount').text(myTable.rows().count());

                        // Fetch and display custom dates from JSON file
                        $.getJSON(datesFilePath)
                            .done(function(data) {
                                $('#lastPubMedScraping').text(data.last_pubmed_scraping || 'N/A');
                                $('#lastLlmCuration').text(data.last_llm_curation || 'N/A');
                                $('#lastApplicationCuration').text(data.last_application_curation || 'N/A');
                            })
                            .fail(function(jqxhr, textStatus, error) {
                                console.error("Error loading dates file:", textStatus, error);
                                $('#lastPubMedScraping').text('Error: N/A');
                                $('#lastLlmCuration').text('Error: N/A');
                                $('#lastApplicationCuration').text('Error: N/A');
                            });
                        // --- END Dynamic Info Update ---

                        console.log("Table initialized with custom column order, specified columns displayed, and 'title' column truncated.");
                    },
                    error: function(err, file, inputElem, reason) {
                        console.error("PapaParse loading error:", err, reason);
                        alert("Error loading CSV file. Please check your browser's console for network errors.");
                    }
                });
            }

            loadCsvAndInitializeTable();
        });
    </script>
</body>
</html>